name: Upload Release to Telegram

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Enter a release tag (leave empty to use the latest)"
        required: false
        default: ""

jobs:
  telegram-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # Step 1: Verify Telegram Bot
      - name: Verify Telegram Bot
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          echo "Testing Telegram bot connection..."
          curl -s "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/getMe"

      # Step 2: Get Release by Tag (only if tag provided)
      - name: Get Release by Tag
        if: ${{ github.event.inputs.tag_name != '' }}
        id: release_by_tag
        uses: octokit/request-action@v2.x
        with:
          route: GET /repos/${{ github.repository }}/releases/tags/${{ github.event.inputs.tag_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 3: Get Latest Release (only if no tag)
      - name: Get Latest Release
        if: ${{ github.event.inputs.tag_name == '' }}
        id: release_latest
        uses: octokit/request-action@v2.x
        with:
          route: GET /repos/${{ github.repository }}/releases/latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Step 4: Save Release JSON to File
      - name: Save Release JSON
        shell: bash
        run: |
          if [ "${{ github.event.inputs.tag_name }}" != "" ]; then
            echo '${{ steps.release_by_tag.outputs.data }}' > release.json
          else
            echo '${{ steps.release_latest.outputs.data }}' > release.json

      # Step 5: Upload Assets One by One to Telegram
      - name: Upload Assets to Telegram
        shell: bash
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Parse release info
          tag_name=$(jq -r '.tag_name' release.json)
          html_url=$(jq -r '.html_url' release.json)
          body=$(jq -r '.body' release.json)

          # Get all asset URLs
          mapfile -t assets < <(jq -r '.assets[]?.browser_download_url' release.json)

          if [ ${#assets[@]} -eq 0 ]; then
            echo "❌ No assets found in the release."
            exit 0
          fi

          # Loop through each asset
          for url in "${assets[@]}"; do
            filename=$(basename "$url")
            echo "Downloading $filename..."
            curl -L -o "$filename" "$url"

            echo "Uploading $filename to Telegram..."
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument" \
              -F chat_id="${TELEGRAM_CHAT_ID}" \
              -F document=@"$filename" \
              -F caption="📦 *${{ github.repository }}*
              🔖 *Release:* ${tag_name}
              🔗 [View on GitHub](${html_url})

              📝 *Changelog:*
              $body" \
              -F parse_mode="Markdown"
          done
