name: Upload Release Assets to Telegram

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Enter release tag (leave empty to use latest)"
        required: false
        default: ""

jobs:
  telegram-upload:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # Step 1: Get release by tag or latest
      - name: Get release info
        id: get_release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ github.event.inputs.tag_name }}';
            let release;
            if (tag) {
              release = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag
              }).then(r => r.data).catch(() => null);
            }
            if (!release) {
              release = await github.rest.repos.getLatestRelease({
                owner: context.repo.owner,
                repo: context.repo.repo
              }).then(r => r.data);
            }
            // Save assets array to a simple text file (one URL per line)
            const urls = release.assets.map(a => a.browser_download_url).join('\n');
            require('fs').writeFileSync('assets.txt', urls);
            console.log(`Found ${release.assets.length} assets.`);

      # Step 2: Upload assets one by one
      - name: Upload Assets to Telegram
        shell: bash
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ ! -s assets.txt ]; then
            echo "‚ùå No assets found to upload."
            exit 0
          fi

          while read -r url; do
            filename=$(basename "$url")
            echo "Downloading $filename..."
            curl -L -o "$filename" "$url"

            echo "Uploading $filename to Telegram..."
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendDocument" \
              -F chat_id="${TELEGRAM_CHAT_ID}" \
              -F document=@"$filename"
          done < assets.txt
